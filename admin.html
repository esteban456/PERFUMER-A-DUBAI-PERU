<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Panel Admin - SULTAN ESSENCE</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Inter,Arial;
  background:#0b0b0b;
  color:white;
  min-height:100vh;
  padding:20px;
}
.box{
  max-width:1000px;
  margin:auto;
  background:#111;
  padding:24px;
  border-radius:12px;
  box-shadow:0 8px 25px rgba(0,0,0,0.4);
}
h1{font-family:Cinzel;color:#c7a008;margin-bottom:10px}
label{font-weight:600;margin-top:10px;display:block}
input,textarea,select{
  width:100%;
  padding:10px;
  background:#222;
  border:1px solid #333;
  border-radius:8px;
  color:white;
  margin-top:5px;
}
button{
  background:#c7a008;
  border:none;
  padding:12px 14px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  margin-top:14px;
}
.product-list{
  margin-top:20px;
}
.item{
  display:flex;
  align-items:center;
  gap:14px;
  background:#1a1a1a;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
}
.item img{
  width:64px;
  height:64px;
  border-radius:8px;
  object-fit:cover;
}
.actions button{
  margin-left:8px;
}
.small-note{font-size:13px;color:#bfb7a6;margin-top:6px}
.alert{margin-top:12px;padding:10px;border-radius:8px;display:none}
.alert.success{background:#e6f9ea;color:#1b6b2a}
.alert.error{background:#fee9d0;color:#5a3b00}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:220px}

/* ====== RESPONSIVE ====== */
@media (max-width:900px){
  body{padding:14px;}
  .box{padding:18px;border-radius:10px}
  .row{flex-direction:column}
  .item{flex-direction:row;gap:12px}
  .item img{width:56px;height:56px}
  .col{min-width:unset}
  h1{font-size:20px}
  button{padding:10px 12px}
}

@media (max-width:480px){
  .item{flex-direction:column;align-items:flex-start}
  .item img{width:100%;height:auto;max-height:160px;object-fit:cover;border-radius:8px}
  .actions{display:flex;gap:8px;width:100%;justify-content:flex-end;margin-top:8px}
  .actions button{flex:1}
  .row{gap:10px}
  .box{padding:14px}
}
</style>
</head>

<body>

<div class="box">

  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>Panel de Administración</h1>
    <div style="display:flex;gap:10px;align-items:center">
      <button onclick="logout()">Cerrar sesión</button>
    </div>
  </div>

  <h2 style="margin-top:20px;color:#c7a008">Añadir / Editar artículo</h2>

  <div id="alertBox" class="alert"></div>

  <!-- FORMULARIO -->
  <div class="row">
    <div class="col">
      <label>Nombre del producto</label>
      <input id="p_name" placeholder="Ej: Sultan Oud">

      <label>Precio (S/)</label>
      <input id="p_price" type="number" placeholder="150">

      <label>Sexo</label>
      <select id="p_sexo">
        <option value="Unisex">Unisex</option>
        <option value="Hombre">Hombre</option>
        <option value="Mujer">Mujer</option>
      </select>

      <label>Categoría</label>
      <select id="p_cat">
        <option value="Fragancia">Fragancia</option>
        <option value="Aceite">Aceite</option>
        <option value="Set">Set</option>
      </select>
    </div>

    <div class="col">
      <label>Descripción</label>
      <textarea id="p_desc" rows="4" placeholder="Descripción del perfume"></textarea>

      <label>Imagen del producto (URL)</label>
      <input id="p_img" type="text" placeholder="https://...">

      <label>O subir archivo (JPG/PNG)</label>
      <input id="p_file" type="file" accept="image/*">
      <div class="small-note">Si subes archivo se usará como imagen (convertida a Base64). Si no, se usará la URL.</div>

      <!-- NUEVO: Checkbox destacado -->
      <label style="margin-top:8px;">
        <input type="checkbox" id="p_destacado">
        Producto destacado
      </label>
    </div>
  </div>

  <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
    <button id="saveBtn" onclick="addOrUpdateProduct()">Guardar producto</button>
    <button id="clearBtn" style="background:#444;color:white" onclick="resetForm()">Limpiar</button>
  </div>

  <h2 style="margin-top:30px;color:#c7a008">Artículos publicados</h2>

  <div id="productList" class="product-list">Cargando...</div>

</div>

<script src="js/auth.js"></script>

<script>
protectAdmin(); // asegura que solo admin accede

// ---------- Helpers para productos ----------
function getProducts(){
  const raw = localStorage.getItem("sultan_products");
  return raw ? JSON.parse(raw) : [];
}
function saveProducts(list){
  localStorage.setItem("sultan_products", JSON.stringify(list));
}
function idGen(){ return 'p_' + Date.now() + '_' + Math.floor(Math.random()*9000); }

// convierte archivo a base64
function fileToBase64(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (e) => reject(e);
    reader.readAsDataURL(file);
  });
}

// estado de edición
let editingId = null;

// mostrar alert
function showAlert(msg, type='success'){
  const a = document.getElementById('alertBox');
  a.style.display = 'block';
  a.textContent = msg;
  a.className = 'alert ' + (type==='success' ? 'success' : 'error');
  setTimeout(()=>{ a.style.display = 'none'; }, 2500);
}

// renderizar lista
function renderProducts(){
  const list = getProducts();
  const container = document.getElementById('productList');
  if(list.length === 0){
    container.innerHTML = "<div style='opacity:0.6'>No hay productos publicados</div>";
    return;
  }
  container.innerHTML = '';
  list.forEach(p => {
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <img src="${p.image}" alt="${p.name}">
      <div style="flex:1">
        <strong>${p.name}</strong>
        <div style="font-size:13px;color:#bfb7a6">${p.sexo} · ${p.cat} · S/${p.price}</div>
        <div style="margin-top:6px;color:#ccc;font-size:13px">${p.desc ? (p.desc.length>120 ? p.desc.slice(0,120)+'…' : p.desc) : ''}</div>
        ${p.destacado ? '<div style="color:#f2d78c;font-size:13px;margin-top:4px">★ Destacado</div>' : ''}
      </div>
      <div class="actions" style="display:flex;gap:8px;align-items:center">
        <button onclick="startEdit('${p.id}')" style="background:#333;color:white;padding:8px;border-radius:8px">Editar</button>
        <button onclick="removeProduct('${p.id}')" style="background:#a11;color:white;padding:8px;border-radius:8px">Eliminar</button>
      </div>
    `;
    container.appendChild(el);
  });
}

// limpiar formulario
function resetForm(){
  editingId = null;
  document.getElementById('p_name').value = '';
  document.getElementById('p_price').value = '';
  document.getElementById('p_cat').value = 'Fragancia';
  document.getElementById('p_sexo').value = 'Unisex';
  document.getElementById('p_desc').value = '';
  document.getElementById('p_img').value = '';
  document.getElementById('p_file').value = '';
  document.getElementById('p_destacado').checked = false;
  document.getElementById('saveBtn').textContent = 'Guardar producto';
}

// iniciar edición
function startEdit(id){
  const list = getProducts();
  const p = list.find(x => x.id === id);
  if(!p) return;
  editingId = id;
  document.getElementById('p_name').value = p.name;
  document.getElementById('p_price').value = p.price;
  document.getElementById('p_cat').value = p.cat;
  document.getElementById('p_sexo').value = p.sexo || 'Unisex';
  document.getElementById('p_desc').value = p.desc || '';
  document.getElementById('p_img').value = p.image && p.image.startsWith('data:') ? '' : p.image;
  document.getElementById('p_file').value = '';
  document.getElementById('p_destacado').checked = !!p.destacado;
  document.getElementById('saveBtn').textContent = 'Actualizar producto';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// eliminar producto
function removeProduct(id){
  if(!confirm('Eliminar producto?')) return;
  const list = getProducts().filter(x => x.id !== id);
  saveProducts(list);
  renderProducts();
  showAlert('Producto eliminado', 'success');
}

// agregar o actualizar producto
async function addOrUpdateProduct(){
  const name = document.getElementById('p_name').value.trim();
  const price = document.getElementById('p_price').value.trim();
  const cat = document.getElementById('p_cat').value;
  const sexo = document.getElementById('p_sexo').value;
  const desc = document.getElementById('p_desc').value.trim();
  const url = document.getElementById('p_img').value.trim();
  const fileInput = document.getElementById('p_file');
  const destacado = document.getElementById('p_destacado').checked;

  if(!name || !price){
    showAlert('Nombre y precio son obligatorios', 'error');
    return;
  }

  let imageSrc = url || '';

  if(fileInput.files && fileInput.files.length > 0){
    try{
      imageSrc = await fileToBase64(fileInput.files[0]);
    } catch(e){
      console.error(e);
    }
  }

  if(!imageSrc){
    imageSrc = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%' height='100%' fill='#ddd'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#666' font-size='22'>Sin imagen</text></svg>`);
  }

  const list = getProducts();

  if(editingId){
    const idx = list.findIndex(x => x.id === editingId);
    if(idx === -1) return;
    list[idx] = { ...list[idx], name, price, cat, sexo, desc, image: imageSrc, destacado };
    saveProducts(list);
    showAlert('Producto actualizado', 'success');
  } else {
    const prod = { id: idGen(), name, price, cat, sexo, desc, image: imageSrc, destacado, createdAt: new Date().toISOString() };
    list.unshift(prod);
    saveProducts(list);
    showAlert('Producto guardado', 'success');
  }

  resetForm();
  renderProducts();
}

// inicializar
renderProducts();
</script>

</body>
</html>
